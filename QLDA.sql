-- Tạo CSDL QLDeAn
CREATE DATABASE QLDA;
GO

-- Chuyển sang CSDL QLDeAn
USE QLDA;
GO

-- Tạo bảng
---- Tạo bảng DEAN
CREATE TABLE DEAN (
	MADA int PRIMARY KEY,
	TENDA nvarchar(100) NOT NULL,
	DIADIEM nvarchar(100),
	MAPHONG int
);
---- Tạo bảng PHONGBAN
CREATE TABLE PHONGBAN (
	MAPHONG int PRIMARY KEY,
	TENPHONG nvarchar(100) NOT NULL,
	MANV_TRUONGPHONG int,
	NGAYNHANCHUC date
);
---- Tạo bảng DIADIEMPHONG
CREATE TABLE DIADIEMPHONG (
	MAPHONG int,
	DIADIEM nvarchar(100)
	CONSTRAINT PK_DIADIEMPHONG PRIMARY KEY (MAPHONG, DIADIEM)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);
---- Tạo bảng NHANVIEN
CREATE TABLE NHANVIEN (
	MANV int PRIMARY KEY,
	HO nvarchar(20) NOT NULL,
	TENLOT nvarchar(50) NOT NULL,
	TEN nvarchar(20) NOT NULL,
	NGAYSINH date,
	DIACHI nvarchar(100),
	PHAI bit,
	LUONG int,
	MANV_QUANLY int,
	MAPHONG int
);
---- Tạo bảng THANNHAN
CREATE TABLE THANNHAN (
	MANV int,
	TENTN nvarchar(100),
	PHAI bit,
	NGAYSINH date,
	QUANHE nvarchar(20),
	CONSTRAINT PK_THANNHAN PRIMARY KEY (MANV, TENTN)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);
---- Tạo bảng CONGVIEC
CREATE TABLE CONGVIEC (
	MADA int,
	STT int,
	TENCV nvarchar(100),
	CONSTRAINT PK_CONGVIEC PRIMARY KEY (MADA, STT)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);
---- Tạo bảng PHANCONG
CREATE TABLE PHANCONG (
	MANV int,
	MADA int,
	STT int,
	THOIGIAN float,
	CONSTRAINT PK_PHANCONG PRIMARY KEY (MANV, MADA, STT)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);

-- Thêm dữ liệu
---- Thêm dữ liệu vào bảng NHANVIEN
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (9, N'Đinh', N'Bá', N'Tiến', '1960-02-11', N'119 Cống Quỳnh, Tp.HCM', 0, 30000, 5, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (5, N'Nguyễn', N'Thanh', N'Tùng', '1962-08-20', N'222 Nguyễn Văn Cừ, Tp.HCM', 0, 40000, 6, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (7, N'Bùi', N'Ngọc', N'Hằng', '1954-03-11', N'332 Nguyễn Thái Học, Tp.HCM', 0, 25000, 1, 4);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (1, N'Lê', N'Quỳnh', N'Như', '1967-02-01', N'291 Hồ Văn Huê, Tp.HCM', 1, 43000, 6, 4);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (4, N'Nguyễn', N'Mạnh', N'Hùng', '1967-03-04', N'95 Võ Thị Sáu, Vũng Tàu', 0, 38000, 5, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (3, N'Trần', N'Thanh', N'Tâm', '1957-05-04', N'34 Mai Thị Lựu, Tp.HCM', 0, 25000, 5, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (8, N'Trần', N'Hồng', N'Quang', '1967-09-01', N'80 Lê Hồng Phong, Tp.HCM', 0, 25000, 1, 4);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (6, N'Phạm', N'Thị Ngọc', N'Minh', '1965-01-01', N'45 Trưng Vương, Hà Nội', 1, 55000, NULL, 1);
---- Thêm dữ liệu vào bảng PHONGBAN
INSERT INTO PHONGBAN (MAPHONG, TENPHONG, MANV_TRUONGPHONG, NGAYNHANCHUC) VALUES (5, N'Nghiên cứu', 5, '1978-05-22');
INSERT INTO PHONGBAN (MAPHONG, TENPHONG, MANV_TRUONGPHONG, NGAYNHANCHUC) VALUES (4, N'Điều hành', 8, '1985-01-01');
INSERT INTO PHONGBAN (MAPHONG, TENPHONG, MANV_TRUONGPHONG, NGAYNHANCHUC) VALUES (1, N'Quản lý', 6, '1971-06-19');
---- Thêm dữ liệu cho bảng DEAN
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (1, N'Sản phẩm X', N'Vũng Tàu', 5);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (2, N'Sản phẩm Y', N'Nha Trang', 5);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (3, N'Sản phẩm Z', N'Tp.HCM', 5);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (10, N'Tin học hóa', N'Hà Nội', 4);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (20, N'Cáp quang', N'Tp.HCM', 1);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (30, N'Đào tạo', N'Hà Nội', 4);
---- Thêm dữ liệu cho bảng DIADIEMPHONG
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (1, N'Tp.HCM');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (4, N'Hà Nội');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (5, N'Vũng Tàu');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (5, N'Nha Trang');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (5, N'Tp.HCM');
---- Thêm dữ liệu cho bảng THANNHAN
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (5, N'Trinh', 1, '1996-04-05', N'Con gái');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (5, N'Khang', 0, '1993-10-25', N'Con trai');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (5, N'Phương', 1, '1975-05-03', N'Vợ chồng');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (1, N'Minh', 0, '1972-02-29', N'Vợ chồng');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (9, N'Tiến', 0, '1988-01-01', N'Con trai');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (9, N'Châu', 1, '1988-12-30', N'Con gái');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (9, N'Phương', 1, '1957-05-05', N'Vợ chồng');
---- Thêm dữ liệu cho bảng CONGVIEC
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (1, 1, N'Thiết kế sản phẩm X');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (1, 2, N'Thử nghiệm sản phẩm X');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (2, 1, N'Sản xuất sản phẩm Y');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (2, 2, N'Quảng cáo sản phẩm Y');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (3, 1, N'Khuyến mãi sản phẩm Z');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (10, 1, N'Tin học hóa phòng nhân sự');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (10, 2, N'Tin học hóa phòng kinh doanh');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (20, 1, N'Lắp đặt cáp quang');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (30, 1, N'Đào tạo nhân viên Marketing');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (30, 2, N'Đào tạo chuyên viên thiết kế');
---- Thêm dữ liệu vào bảng PHANCONG
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (9, 1, 1, 32);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (9, 2, 2, 8);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (4, 3, 1, 40);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (3, 1, 2, 20);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (3, 2, 1, 20);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (8, 10, 1, 35);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (8, 30, 2, 5);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (1, 30, 1, 20);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (1, 20, 1, 15);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (6, 20, 1, 30);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (5, 3, 1, 10);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (5, 10, 2, 10);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (5, 20, 1, 10);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (7, 30, 2, 30);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (7, 10, 2, 10);

-- Thêm các ràng buộc khóa ngoại
---- Thêm ràng buộc khóa ngoại cho bảng DEAN
ALTER TABLE DEAN ADD CONSTRAINT FK_DEAN_PHONGBAN FOREIGN KEY (MAPHONG) REFERENCES PHONGBAN(MAPHONG);
---- Thêm ràng buộc khóa ngoại cho bảng PHONGBAN
ALTER TABLE PHONGBAN ADD CONSTRAINT FK_PHONGBAN_NHANVIEN FOREIGN KEY (MANV_TRUONGPHONG) REFERENCES NHANVIEN(MANV);
---- Thêm ràng buộc khóa ngoại cho bảng DIADIEMPHONG
ALTER TABLE DIADIEMPHONG ADD CONSTRAINT FK_DIADIEMPHONG_PHONGBAN FOREIGN KEY (MAPHONG) REFERENCES PHONGBAN(MAPHONG);
---- Thêm ràng buộc khóa ngoại cho bảng NHANVIEN
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_NHANVIEN_NHANVIEN FOREIGN KEY (MANV_QUANLY) REFERENCES NHANVIEN(MANV);
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_NHANVIEN_PHONGBAN FOREIGN KEY (MAPHONG) REFERENCES PHONGBAN(MAPHONG);
---- Thêm ràng buộc khóa ngoại cho bảng CONGVIEC
ALTER TABLE CONGVIEC ADD CONSTRAINT FK_CONGVIEC_DEAN FOREIGN KEY (MADA) REFERENCES DEAN(MADA);
---- Thêm ràng buộc khóa ngoại cho bảng PHANCONG
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV);
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_CONGVIEC FOREIGN KEY (MADA, STT) REFERENCES CONGVIEC(MADA, STT);
---- Thêm ràng buộc khóa ngoại cho bảng THANNHAN
ALTER TABLE THANNHAN ADD CONSTRAINT FK_THANNHAN_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV);

--CAU 1: Liệt kê danh sách nhân viên làm việc ở phòng số 4.Gồm mã nhân viên , họ tên
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN
WHERE MAPHONG = '4'
--CAU 2: Liệt kê danh sách nhân viên có mức lương trên 30.000.Gồm mã nhân viên, họ tên, mức lương
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,LUONG
FROM NHANVIEN
WHERE LUONG > 30000
--CAU 3: Liệt ke danh sách nhân viên có mức lương tren 25000 ở phòng 4 hoặc các cá nhân có mức lương trên 30000 ở phòng 5.Gồm mã nhân viên,họ tên, mã phòng ban,mức lương
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,LUONG,MAPHONG
FROM NHANVIEN
WHERE (LUONG > 30000 AND MAPHONG = '5') OR (LUONG > 25000 AND MAPHONG ='4')
--CAU 4: Liệt kê danh sách nhân viên ở tphcm.Gồm mã nhân viên, họ ten.
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN
WHERE DIACHI LIKE '%HCM'
--CAU 5: Liệt kê danh sách nhân viên có họ bắt đầu bằng ký tự N . Gồm mã nhân viên, họ tên
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN
WHERE HO LIKE 'N%'
--CAU 6: Cho biết ngày sinh và địa chỉ của nhân viên Đinh Bá Tiến
SELECT NGAYSINH,DIACHI
FROM NHANVIEN
WHERE HO =N'Đinh' and TENLOT = N'Bá' and TEN = N'Tiến'
--CAU 7: Liệt kê danh sách nhân viên có năm sinh trong khoảng 1960 đến 1965. Gồm mã nhân viên , ngày sinh, họ tên
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,NGAYSINH
FROM NHANVIEN
WHERE YEAR(NGAYSINH) BETWEEN 1960 AND 1965
--CAU 8: Liệt kê danh sách nhân viên. Gồm mã nhân viên, họ tên, địa chỉ, ngày sinh
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,DIACHI,NGAYSINH
FROM NHANVIEN
--CAU 9: Liệt kê danh sách nhân viên. Gồm mã nhân viên, họ tên, địa chỉ, tuổi
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,DIACHI,YEAR(GETDATE()) - YEAR(NGAYSINH) AS TUỔI
FROM NHANVIEN
---------INNER JOIN--------------------
--CAU 10: Liệt kê danh sách phòng ban. Gồm mã phòng ban, tên phòng ban, địa điểm
SELECT DDP.MAPHONG,TENPHONG,DIADIEM
FROM PHONGBAN PB INNER JOIN DIADIEMPHONG DDP on PB.MAPHONG = DDP.MAPHONG
--CAU 11: Liệt kê danh sách trưởng phòng của từng phòng ban. Gồm họ tên trưởng phòng, tên phòng ban
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,TENPHONG
FROM NHANVIEN NV INNER JOIN PHONGBAN P on NV.MANV = P.MANV_TRUONGPHONG
--CAU 12: Liệt kê danh sách nhân viên của phòng nghiên cứu . Gồm họ tên , địa chỉ
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,DIACHI
FROM NHANVIEN NV INNER JOIN PHONGBAN P on NV.MAPHONG = P.MAPHONG
WHERE TENPHONG = N'Nghiên cứu'
--CAU 13: Liệt kê danh sách đề án ở Hà Nội. Gồm tên đề án , tên phòng ban, họ tên và ngày nhận chức của trưởng phòng ban chủ trì đề án đó
SELECT TENDA,TENPHONG,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,NGAYNHANCHUC
FROM DEAN D INNER JOIN PHONGBAN P on D.MAPHONG = P.MAPHONG
                 INNER JOIN NHANVIEN NV ON P.MANV_TRUONGPHONG  = NV.MANV
WHERE DIADIEM = N'Hà Nội'
--CAU 14: Tìm họ tên những nữ nhân viên, tên người thân của họ và quan hệ với họ
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,TENTN,QUANHE
FROM NHANVIEN NV INNER JOIN THANNHAN T on NV.MANV = T.MANV
WHERE NV.PHAI = 1
--CAU 15: Với mỗi nhân viên,cho biết họ tên nhân viên và họ tên người quản lý trực tiếp của người đó
SELECT (N1.HO + ' ' + N1.TENLOT + ' ' + N1.TEN) AS HOTENNV ,(N2.HO + ' ' + N2.TENLOT + ' ' + N2.TEN) AS HOTENQL
FROM NHANVIEN N1 LEFT JOIN NHANVIEN N2 ON N1.MANV_QUANLY = N2.MANV
--CAU 16: Với mỗi nhân viên, cho biết họ tên của nhân viên, họ tên người truỏng phòng và họ tên người quản lý trực tiếp của nhân viên đó
SELECT (N1.HO + ' ' + N1.TENLOT + ' ' + N1.TEN) AS HOTENNV ,(N2.HO + ' ' + N2.TENLOT + ' ' + N2.TEN) AS HOTENQL,(N3.HO + ' ' + N3.TENLOT + ' ' + N3.TEN) AS HOTENTRUONGPHONG
FROM NHANVIEN N1 LEFT JOIN NHANVIEN N2 ON N1.MANV_QUANLY = N2.MANV
                INNER JOIN PHONGBAN P on N1.MAPHONG = P.MAPHONG
                INNER JOIN NHANVIEN N3 ON P.MANV_TRUONGPHONG = N3.MANV
--CAU 17: Tên những nhân viên phòng số 5 có tham gia vào đề án sản phẩm x và nhân viên này do Nguyễn Thanh Tùng quản lý trục tiếp
SELECT NV.HO + ' ' + NV.TENLOT + ' ' + NV.TEN AS HOTENNV
FROM NHANVIEN NV INNER JOIN PHANCONG P on NV.MANV = P.MANV
                INNER JOIN NHANVIEN QL ON NV.MANV_QUANLY = QL.MANV
                INNER JOIN DEAN D on NV.MAPHONG = D.MAPHONG
WHERE NV.MAPHONG = 5 AND TENDA =N'Sản phẩm X' AND QL.HO =N'Nguyễn' and QL.TENLOT =N'Thanh' and QL.TEN = N'Tùng'
--CAU 18: Cho biết tên các đề án mà nhân viên Đinh Bá Tiến đã tham gia ..https://www.slideshare.net/hai150289/hd-th-sql-servertuan5nkhanh
SELECT TENDA
FROM DEAN DA INNER JOIN PHANCONG P on DA.MADA = P.MADA
            INNER JOIN NHANVIEN N on DA.MAPHONG = N.MAPHONG
WHERE HO  + ' ' + TENLOT  + ' ' + TEN  = N'Đinh Bá Tiến'
--CAU 19: Cho biết số lượng đề án của công ty
SELECT COUNT(*) AS SLDA
FROM DEAN
--CAU 2O: Cho biết số lượng đề án của phòng nghiên cứu chủ trì
SELECT COUNT(*) AS SLDA
FROM DEAN INNER JOIN PHONGBAN P on DEAN.MAPHONG = P.MAPHONG
WHERE TENPHONG = N'Nghiên cứu'
GROUP BY TENPHONG
--CAU 21: Cho biết mức lương trung bình của các nữ nhân viên
SELECT AVG(LUONG)
FROM NHANVIEN
WHERE PHAI = 1
--CAU 22: Cho biết số thân nhân của nhân viên Đinh Bá Tiến
SELECT COUNT(*)
FROM NHANVIEN NV INNER JOIN THANNHAN T on NV.MANV = T.MANV
WHERE HO =N'Đinh' and TENLOT =N'Bá' and TEN = N'Tiến'
--CAU 23: Với mỗi đề án, liệt kê tên dự án và tổng số giờ làm việc một tuần của tất cả các nhân viên tham gia đề án đó
SELECT TENDA, SUM(THOIGIAN) AS TONGGIO
FROM PHANCONG INNER JOIN DEAN D on PHANCONG.MADA = D.MADA
GROUP BY TENDA
--CAU 24: Với mỗi đề án, cho biết tên đề án và số nhân viên tham gia đề án đó
SELECT TENDA, COUNT(MANV) AS SONVTHAMGIA
FROM DEAN INNER JOIN PHANCONG P on DEAN.MADA = P.MADA
GROUP BY TENDA
--CAU 25: Với mỗi nhân viên, cho biết họ tên nhân viên và số lượng thân nhân của nhân viên đó
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTENNV,COUNT(TENTN) AS SOTHANNHAN
FROM NHANVIEN NV INNER JOIN THANNHAN T on NV.MANV = T.MANV
GROUP BY HO + ' ' + TENLOT + ' ' + TEN
-- Câu 26. Với mỗi nhân viên, cho biết họ tên nhân viên và số lượng đề án mà nhân viên đó đã tham gia.
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN, COUNT(MADA) AS SODEAN
FROM NHANVIEN NV INNER JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY HO, TENLOT, TEN

-- Câu 27. Với mỗi nhân viên, cho biết số lượng nhân viên mà nhân viên đó quản lý trực tiếp.
SELECT QL.HO + ' ' + QL.TENLOT + ' ' + QL.TEN AS HOTEN, COUNT(NV.MANV_QUANLY) AS SONVDUOCQUANLY
FROM NHANVIEN QL LEFT JOIN NHANVIEN NV ON QL.MANV = NV.MANV_QUANLY
GROUP BY QL.HO, QL.TENLOT, QL.TEN

-- Câu 28. Với mỗi phòng ban, liệt kê tên phòng ban và lương trung bình của những nhân viên làm việc tại phòng ban đó.
SELECT TENPHONG, AVG(LUONG) AS LUONGTB
FROM PHONGBAN PB INNER JOIN NHANVIEN NV ON PB.MAPHONG = NV.MAPHONG
GROUP BY PB.MAPHONG, PB.TENPHONG

-- Câu 29. Với các phòng ban có mức lương trung bình trên 33.000, liệt kê tên phòng ban và số lượng nhân viên của phòng ban đó.
SELECT TENPHONG, COUNT(MANV) AS SOLUONGNV
FROM PHONGBAN PB INNER JOIN NHANVIEN NV ON PB.MAPHONG = NV.MAPHONG
GROUP BY TENPHONG
HAVING AVG(LUONG) > 33000

-- Câu 30. Với mỗi phòng ban, cho biết tên phòng ban và số lượng đề án mà phòng ban đó chủ trì.
SELECT TENPHONG, COUNT(MADA) AS SOLUONGDA
FROM PHONGBAN PB INNER JOIN DEAN DA ON PB.MAPHONG = DA.MAPHONG
GROUP BY TENPHONG

-- Câu 31. Với mỗi phòng ban, cho biết tên phòng ban, họ tên người trưởng phòng và số lượng đề án mà phòng ban đó chủ trì.
SELECT TENPHONG, HO + ' ' + TENLOT + ' ' + TEN AS HOTENTP, COUNT(MADA) AS SOLUONGDA
FROM
	PHONGBAN PB INNER JOIN DEAN DA ON PB.MAPHONG = DA.MAPHONG
				INNER JOIN NHANVIEN NV ON PB.MANV_TRUONGPHONG = NV.MANV
GROUP BY TENPHONG, HO, TENLOT, TEN

-- Câu 32. Với mỗi phòng ban có mức lương trung bình lớn hơn 40.000, cho biết tên phòng ban và số lượng đề án mà phòng ban đó chủ trì.
SELECT TENPHONG, COUNT(DISTINCT MADA) AS SOLUONGDA
FROM
	PHONGBAN PB INNER JOIN DEAN DA ON PB.MAPHONG = DA.MAPHONG
				INNER JOIN NHANVIEN NV ON PB.MAPHONG = NV.MAPHONG
GROUP BY PB.MAPHONG, TENPHONG
HAVING AVG(LUONG) > 40000

-- Câu 33. Cho biết số đề án diễn ra tại từng địa điểm.
SELECT DIADIEM, COUNT(MADA) AS SOLUONGDA
FROM DEAN
GROUP BY DIADIEM

-- Câu 34. Với mỗi đề án, cho biết tên đề án và số lượng công việc của đề án này.
SELECT TENDA, COUNT(CV.MADA) AS SOLUONGCV
FROM DEAN DA INNER JOIN CONGVIEC CV ON DA.MADA = CV.MADA
GROUP BY CV.MADA, TENDA

-- Câu 35. Với mỗi công việc trong đề án có mã đề án là 30, cho biết số lượng nhân viên được phân công.
SELECT TENCV, COUNT(MANV) AS SOLUONGNV
FROM CONGVIEC CV INNER JOIN PHANCONG PC ON CV.MADA = PC.MADA AND CV.STT = PC.STT
WHERE CV.MADA = 30
GROUP BY CV.MADA, TENCV

-- Câu 36. Với mỗi công việc trong đề án "Đào tạo", cho biết số lượng nhân viên được phân công.
SELECT TENCV, COUNT(MANV) AS SOLUONGNV
FROM
	DEAN DA INNER JOIN CONGVIEC CV ON DA.MADA = CV.MADA
			INNER JOIN PHANCONG PC ON CV.MADA = PC.MADA AND CV.STT = PC.STT
WHERE TENDA = N'Đào tạo'
GROUP BY TENCV

-- Câu 37. Cho biết danh sách các mã đề án có: Nhân viên có họ là "Đinh" tham gia HOẶC có trưởng phòng chủ trì đề án với họ là "Phạm".
SELECT DISTINCT MADA
FROM PHANCONG PC INNER JOIN NHANVIEN NV ON PC.MANV = NV.MANV
WHERE HO = N'Đinh'
UNION
SELECT DISTINCT MADA
FROM
	DEAN DA INNER JOIN PHONGBAN PB ON DA.MAPHONG = PB.MAPHONG
			INNER JOIN NHANVIEN NV ON PB.MANV_TRUONGPHONG = NV.MANV
WHERE HO = N'Phạm'

-- Câu 38. Liệt kê họ tên của những nhân viên có trên 2 thân nhân.
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN NV INNER JOIN THANNHAN TN ON NV.MANV = TN.MANV
GROUP BY HO, TENLOT, TEN
HAVING COUNT(TN.MANV) > 2

-- Câu 39. Liệt kê họ tên của những nhân viên không có thân nhân nào.
---- Cách 1: Truy vấn trực tiếp
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN NV LEFT JOIN THANNHAN TN ON NV.MANV = TN.MANV
GROUP BY HO, TENLOT, TEN
HAVING COUNT(TN.MANV) = 0
---- Cách 2: Truy vấn lồng
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN
WHERE MANV NOT IN (
	SELECT DISTINCT MANV
	FROM THANNHAN
)

-- Câu 40. Liệt kê họ tên của những trưởng phòng có tối thiểu một thân nhân.
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTENTP
FROM NHANVIEN NV INNER JOIN THANNHAN TN ON NV.MANV = TN.MANV
WHERE NV.MANV IN (
	SELECT MANV_TRUONGPHONG
	FROM PHONGBAN
)
GROUP BY HO, TENLOT, TEN
HAVING COUNT(TN.MANV) >= 1

-- Câu 41. Liệt kê họ tên của những trưởng phòng chưa lập gia đình.
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTENTP
FROM NHANVIEN NV LEFT JOIN THANNHAN TN ON NV.MANV = TN.MANV
WHERE NV.MANV IN (
	SELECT MANV_TRUONGPHONG
	FROM PHONGBAN
) AND NV.MANV NOT IN (
	SELECT MANV
	FROM THANNHAN
	WHERE QUANHE = N'Vợ chồng'
)

-- Câu 42. Liệt kê họ tên và mức lương của những nhân viên có mức lương trên mức lương trung bình của phòng "Nghiên cứu".
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN, LUONG
FROM NHANVIEN
WHERE LUONG > (
	SELECT AVG(LUONG)
	FROM NHANVIEN NV INNER JOIN PHONGBAN PB ON NV.MAPHONG = PB.MAPHONG
	WHERE TENPHONG = N'Nghiên cứu'
)

-- Câu 43. Liệt kê tên phòng ban và họ tên trưởng phòng của phòng ban có đông nhân viên nhất.
SELECT TENPHONG, HO + ' ' + TENLOT + ' ' + TEN AS HOTENTP
FROM PHONGBAN PB INNER JOIN NHANVIEN NV ON PB.MANV_TRUONGPHONG = NV.MANV
WHERE PB.MAPHONG IN (
	SELECT MAPHONG
	FROM NHANVIEN
	GROUP BY MAPHONG
	HAVING COUNT(MANV) = (
		SELECT TOP 1 COUNT(MANV) AS SLNV
		FROM NHANVIEN
		GROUP BY MAPHONG
		ORDER BY SLNV DESC
	)
)

-- Câu 44. Liệt kê danh sách các mã đề án và tên đề án mà nhân viên có mã là 9 không tham gia.
SELECT MADA, TENDA
FROM DEAN
WHERE MADA NOT IN (
	SELECT MADA
	FROM PHANCONG
	WHERE MANV = 9
)

-- Câu 45. Liệt kê danh sách tên công việc trong đề án "Sản phẩm X" mà nhân viên có mã là 9 chưa làm.
SELECT TENCV
FROM CONGVIEC CV INNER JOIN DEAN DA ON CV.MADA = DA.MADA
WHERE TENDA = N'Sản phẩm X' AND TENCV NOT IN (
	SELECT TENCV
	FROM CONGVIEC CV INNER JOIN PHANCONG PC ON CV.MADA = PC.MADA AND CV.STT = PC.STT
	WHERE MANV = 9
)


