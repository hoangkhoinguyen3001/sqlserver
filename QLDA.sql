-- Tạo CSDL QLDeAn
CREATE DATABASE QLDA;
GO

-- Chuyển sang CSDL QLDeAn
USE QLDA;
GO

-- Tạo bảng
---- Tạo bảng DEAN
CREATE TABLE DEAN (
	MADA int PRIMARY KEY,
	TENDA nvarchar(100) NOT NULL,
	DIADIEM nvarchar(100),
	MAPHONG int
);
---- Tạo bảng PHONGBAN
CREATE TABLE PHONGBAN (
	MAPHONG int PRIMARY KEY,
	TENPHONG nvarchar(100) NOT NULL,
	MANV_TRUONGPHONG int,
	NGAYNHANCHUC date
);
---- Tạo bảng DIADIEMPHONG
CREATE TABLE DIADIEMPHONG (
	MAPHONG int,
	DIADIEM nvarchar(100)
	CONSTRAINT PK_DIADIEMPHONG PRIMARY KEY (MAPHONG, DIADIEM)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);
---- Tạo bảng NHANVIEN
CREATE TABLE NHANVIEN (
	MANV int PRIMARY KEY,
	HO nvarchar(20) NOT NULL,
	TENLOT nvarchar(50) NOT NULL,
	TEN nvarchar(20) NOT NULL,
	NGAYSINH date,
	DIACHI nvarchar(100),
	PHAI bit,
	LUONG int,
	MANV_QUANLY int,
	MAPHONG int
);
---- Tạo bảng THANNHAN
CREATE TABLE THANNHAN (
	MANV int,
	TENTN nvarchar(100),
	PHAI bit,
	NGAYSINH date,
	QUANHE nvarchar(20),
	CONSTRAINT PK_THANNHAN PRIMARY KEY (MANV, TENTN)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);
---- Tạo bảng CONGVIEC
CREATE TABLE CONGVIEC (
	MADA int,
	STT int,
	TENCV nvarchar(100),
	CONSTRAINT PK_CONGVIEC PRIMARY KEY (MADA, STT)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);
---- Tạo bảng PHANCONG
CREATE TABLE PHANCONG (
	MANV int,
	MADA int,
	STT int,
	THOIGIAN float,
	CONSTRAINT PK_PHANCONG PRIMARY KEY (MANV, MADA, STT)	-- Tạo ràng buộc khóa chính cho 2+ thuộc tính
);

-- Thêm dữ liệu
---- Thêm dữ liệu vào bảng NHANVIEN
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (9, N'Đinh', N'Bá', N'Tiến', '1960-02-11', N'119 Cống Quỳnh, Tp.HCM', 0, 30000, 5, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (5, N'Nguyễn', N'Thanh', N'Tùng', '1962-08-20', N'222 Nguyễn Văn Cừ, Tp.HCM', 0, 40000, 6, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (7, N'Bùi', N'Ngọc', N'Hằng', '1954-03-11', N'332 Nguyễn Thái Học, Tp.HCM', 0, 25000, 1, 4);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (1, N'Lê', N'Quỳnh', N'Như', '1967-02-01', N'291 Hồ Văn Huê, Tp.HCM', 1, 43000, 6, 4);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (4, N'Nguyễn', N'Mạnh', N'Hùng', '1967-03-04', N'95 Võ Thị Sáu, Vũng Tàu', 0, 38000, 5, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (3, N'Trần', N'Thanh', N'Tâm', '1957-05-04', N'34 Mai Thị Lựu, Tp.HCM', 0, 25000, 5, 5);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (8, N'Trần', N'Hồng', N'Quang', '1967-09-01', N'80 Lê Hồng Phong, Tp.HCM', 0, 25000, 1, 4);
INSERT INTO NHANVIEN (MANV, HO, TENLOT, TEN, NGAYSINH, DIACHI, PHAI, LUONG, MANV_QUANLY, MAPHONG) VALUES (6, N'Phạm', N'Thị Ngọc', N'Minh', '1965-01-01', N'45 Trưng Vương, Hà Nội', 1, 55000, NULL, 1);
---- Thêm dữ liệu vào bảng PHONGBAN
INSERT INTO PHONGBAN (MAPHONG, TENPHONG, MANV_TRUONGPHONG, NGAYNHANCHUC) VALUES (5, N'Nghiên cứu', 5, '1978-05-22');
INSERT INTO PHONGBAN (MAPHONG, TENPHONG, MANV_TRUONGPHONG, NGAYNHANCHUC) VALUES (4, N'Điều hành', 8, '1985-01-01');
INSERT INTO PHONGBAN (MAPHONG, TENPHONG, MANV_TRUONGPHONG, NGAYNHANCHUC) VALUES (1, N'Quản lý', 6, '1971-06-19');
---- Thêm dữ liệu cho bảng DEAN
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (1, N'Sản phẩm X', N'Vũng Tàu', 5);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (2, N'Sản phẩm Y', N'Nha Trang', 5);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (3, N'Sản phẩm Z', N'Tp.HCM', 5);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (10, N'Tin học hóa', N'Hà Nội', 4);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (20, N'Cáp quang', N'Tp.HCM', 1);
INSERT INTO DEAN (MADA, TENDA, DIADIEM, MAPHONG) VALUES (30, N'Đào tạo', N'Hà Nội', 4);
---- Thêm dữ liệu cho bảng DIADIEMPHONG
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (1, N'Tp.HCM');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (4, N'Hà Nội');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (5, N'Vũng Tàu');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (5, N'Nha Trang');
INSERT INTO DIADIEMPHONG (MAPHONG, DIADIEM) VALUES (5, N'Tp.HCM');
---- Thêm dữ liệu cho bảng THANNHAN
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (5, N'Trinh', 1, '1996-04-05', N'Con gái');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (5, N'Khang', 0, '1993-10-25', N'Con trai');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (5, N'Phương', 1, '1975-05-03', N'Vợ chồng');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (1, N'Minh', 0, '1972-02-29', N'Vợ chồng');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (9, N'Tiến', 0, '1988-01-01', N'Con trai');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (9, N'Châu', 1, '1988-12-30', N'Con gái');
INSERT INTO THANNHAN (MANV, TENTN, PHAI, NGAYSINH, QUANHE) VALUES (9, N'Phương', 1, '1957-05-05', N'Vợ chồng');
---- Thêm dữ liệu cho bảng CONGVIEC
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (1, 1, N'Thiết kế sản phẩm X');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (1, 2, N'Thử nghiệm sản phẩm X');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (2, 1, N'Sản xuất sản phẩm Y');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (2, 2, N'Quảng cáo sản phẩm Y');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (3, 1, N'Khuyến mãi sản phẩm Z');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (10, 1, N'Tin học hóa phòng nhân sự');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (10, 2, N'Tin học hóa phòng kinh doanh');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (20, 1, N'Lắp đặt cáp quang');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (30, 1, N'Đào tạo nhân viên Marketing');
INSERT INTO CONGVIEC (MADA, STT, TENCV) VALUES (30, 2, N'Đào tạo chuyên viên thiết kế');
---- Thêm dữ liệu vào bảng PHANCONG
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (9, 1, 1, 32);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (9, 2, 2, 8);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (4, 3, 1, 40);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (3, 1, 2, 20);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (3, 2, 1, 20);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (8, 10, 1, 35);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (8, 30, 2, 5);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (1, 30, 1, 20);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (1, 20, 1, 15);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (6, 20, 1, 30);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (5, 3, 1, 10);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (5, 10, 2, 10);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (5, 20, 1, 10);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (7, 30, 2, 30);
INSERT INTO PHANCONG (MANV, MADA, STT, THOIGIAN) VALUES (7, 10, 2, 10);

-- Thêm các ràng buộc khóa ngoại
---- Thêm ràng buộc khóa ngoại cho bảng DEAN
ALTER TABLE DEAN ADD CONSTRAINT FK_DEAN_PHONGBAN FOREIGN KEY (MAPHONG) REFERENCES PHONGBAN(MAPHONG);
---- Thêm ràng buộc khóa ngoại cho bảng PHONGBAN
ALTER TABLE PHONGBAN ADD CONSTRAINT FK_PHONGBAN_NHANVIEN FOREIGN KEY (MANV_TRUONGPHONG) REFERENCES NHANVIEN(MANV);
---- Thêm ràng buộc khóa ngoại cho bảng DIADIEMPHONG
ALTER TABLE DIADIEMPHONG ADD CONSTRAINT FK_DIADIEMPHONG_PHONGBAN FOREIGN KEY (MAPHONG) REFERENCES PHONGBAN(MAPHONG);
---- Thêm ràng buộc khóa ngoại cho bảng NHANVIEN
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_NHANVIEN_NHANVIEN FOREIGN KEY (MANV_QUANLY) REFERENCES NHANVIEN(MANV);
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_NHANVIEN_PHONGBAN FOREIGN KEY (MAPHONG) REFERENCES PHONGBAN(MAPHONG);
---- Thêm ràng buộc khóa ngoại cho bảng CONGVIEC
ALTER TABLE CONGVIEC ADD CONSTRAINT FK_CONGVIEC_DEAN FOREIGN KEY (MADA) REFERENCES DEAN(MADA);
---- Thêm ràng buộc khóa ngoại cho bảng PHANCONG
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV);
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_CONGVIEC FOREIGN KEY (MADA, STT) REFERENCES CONGVIEC(MADA, STT);
---- Thêm ràng buộc khóa ngoại cho bảng THANNHAN
ALTER TABLE THANNHAN ADD CONSTRAINT FK_THANNHAN_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV);

--CAU 1: Liệt kê danh sách nhân viên làm việc ở phòng số 4.Gồm mã nhân viên , họ tên
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN
WHERE MAPHONG = '4'
--CAU 2: Liệt kê danh sách nhân viên có mức lương trên 30.000.Gồm mã nhân viên, họ tên, mức lương
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,LUONG
FROM NHANVIEN
WHERE LUONG > 30000
--CAU 3: Liệt ke danh sách nhân viên có mức lương tren 25000 ở phòng 4 hoặc các cá nhân có mức lương trên 30000 ở phòng 5.Gồm mã nhân viên,họ tên, mã phòng ban,mức lương
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,LUONG,MAPHONG
FROM NHANVIEN
WHERE (LUONG > 30000 AND MAPHONG = '5') OR (LUONG > 25000 AND MAPHONG ='4')
--CAU 4: Liệt kê danh sách nhân viên ở tphcm.Gồm mã nhân viên, họ ten.
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN
WHERE DIACHI LIKE '%HCM'
--CAU 5: Liệt kê danh sách nhân viên có họ bắt đầu bằng ký tự N . Gồm mã nhân viên, họ tên
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN
FROM NHANVIEN
WHERE HO LIKE 'N%'
--CAU 6: Cho biết ngày sinh và địa chỉ của nhân viên Đinh Bá Tiến
SELECT NGAYSINH,DIACHI
FROM NHANVIEN
WHERE HO =N'Đinh' and TENLOT = N'Bá' and TEN = N'Tiến'
--CAU 7: Liệt kê danh sách nhân viên có năm sinh trong khoảng 1960 đến 1965. Gồm mã nhân viên , ngày sinh, họ tên
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,NGAYSINH
FROM NHANVIEN
WHERE YEAR(NGAYSINH) BETWEEN 1960 AND 1965
--CAU 8: Liệt kê danh sách nhân viên. Gồm mã nhân viên, họ tên, địa chỉ, ngày sinh
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,DIACHI,NGAYSINH
FROM NHANVIEN
--CAU 9: Liệt kê danh sách nhân viên. Gồm mã nhân viên, họ tên, địa chỉ, tuổi
SELECT MANV,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,DIACHI,2019 - YEAR(NGAYSINH) AS TUỔI
FROM NHANVIEN
---------INNER JOIN--------------------
--CAU 10: Liệt kê danh sách phòng ban. Gồm mã phòng ban, tên phòng ban, địa điểm
SELECT DA.MAPHONG,TENPHONG,DIADIEM
FROM PHONGBAN PB INNER JOIN DEAN DA on PB.MAPHONG = DA.MAPHONG
--CAU 11: Liệt kê danh sách trưởng phòng của từng phòng ban. Gồm họ tên trưởng phòng, tên phòng ban
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,TENPHONG
FROM NHANVIEN NV INNER JOIN PHONGBAN P on NV.MAPHONG = P.MAPHONG
WHERE MANV ='5' OR MANV = '6' OR MANV = '8'
--CAU 12: Liệt kê danh sách nhân viên của phòng nghiên cứu . Gồm họ tên , địa chỉ
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,DIACHI
FROM NHANVIEN
WHERE MAPHONG = '5'
--CAU 13: Liệt kê danh sách đề án ở Hà Nội. Gồm tên đề án , tên phòng ban, họ tên và ngày nhận chức của trưởng phòng ban chủ trì đề án đó
SELECT TENDA,TENPHONG,HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,NGAYNHANCHUC
FROM PHONGBAN PB INNER JOIN DEAN D on PB.MAPHONG = D.MAPHONG
                 INNER JOIN NHANVIEN N on D.MAPHONG = N.MAPHONG
WHERE DIADIEM = N'Hà Nội'and MANV = '8'
--CAU 14: Tìm họ tên những nữ nhân viên, tên người thân của họ và quan hệ với họ
SELECT HO + ' ' + TENLOT + ' ' + TEN AS HOTEN,TENTN,QUANHE
FROM NHANVIEN NV INNER JOIN THANNHAN T on NV.MANV = T.MANV
WHERE NV.PHAI = '1'
--CAU 15: Với mỗi nhân viên,cho biết họ tên nhân viên và họ tên người quản lý trực tiếp của người đó
SELECT (N1.HO + ' ' + N1.TENLOT + ' ' + N1.TEN) AS HOTENNV ,(N2.HO + ' ' + N2.TENLOT + ' ' + N2.TEN) AS HOTENQL
FROM NHANVIEN N1,NHANVIEN N2
WHERE (N1.MANV_QUANLY = N2.MANV)
--CAU 16: Với mỗi nhân viên, cho biết họ tên của nhân viên, họ tên người truỏng phòng và họ tên người quản lý trực tiếp của nhân viên đó
SELECT (N1.HO + ' ' + N1.TENLOT + ' ' + N1.TEN) AS HOTENNV ,(N2.HO + ' ' + N2.TENLOT + ' ' + N2.TEN) AS HOTENQL,(N3.HO + ' ' + N3.TENLOT + ' ' + N3.TEN) AS HOTENTRUONGPHONG
FROM NHANVIEN N1,NHANVIEN N2,NHANVIEN N3,PHONGBAN
WHERE ((N1.MANV_QUANLY = N2.MANV) AND (N3.MANV = PHONGBAN.MANV_TRUONGPHONG) AND (PHONGBAN.MAPHONG = N1.MAPHONG) )
--CAU 17: Tên những nhân viên phòng số 5 có tham gia vào đề án sản phẩm x và nhân viên này do Nguyễn Thanh Tùng quản lý trục tiếp
SELECT (N1.HO + ' ' + N1.TENLOT + ' ' + N1.TEN) AS HOTENNV ,(N2.HO + ' ' + N2.TENLOT + ' ' + N2.TEN) AS HOTENQL
FROM NHANVIEN N1, NHANVIEN N2,DEAN,PHANCONG
WHERE DEAN.TENDA like '%X' and DEAN.MADA = PHANCONG.MADA
      AND N1.MANV = PHANCONG.MANV AND N1.MAPHONG = '5'
      AND N1.MANV_QUANLY = N2.MANV AND N2.HO = N'Nguyễn'
      and N2.TENLOT = 'Thanh' and N2.TEN = 'Tùng'
--CAU 18: Cho biết tên các đề án mà nhân viên Đinh Bá Tiến đã tham gia ..https://www.slideshare.net/hai150289/hd-th-sql-servertuan5nkhanh
SELECT HO,TENLOT,TEN,TENDA
FROM NHANVIEN,PHONGBAN,DEAN
WHERE NHANVIEN.MAPHONG = '5' AND PHONGBAN.MAPHONG ='5' AND DEAN.MAPHONG = '5'
      AND NHANVIEN.HO = N'Đinh' and NHANVIEN.TENLOT = N'Bá' and NHANVIEN.TEN = N'Tiến'